// Prisma schema: Radiotaxis ORM — versión final optimizada con índices

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

//
// ────────────────────────────
//  MODELOS BASE
// ────────────────────────────
//

model Persona {
  id                  Int       @id @default(autoincrement())
  nombre              String
  apellido_paterno    String?
  apellido_materno    String?
  genero              String?
  foto_url            String?

  // Auditoría
  fecha_creacion      DateTime  @default(now())
  fecha_modificacion  DateTime?
  activo              Boolean   @default(true)
  eliminado           Boolean   @default(false)

  // Relaciones
  usuario    Usuario?   @relation("PersonaUsuario")
  contactos  Contacto[]
  documentos Documento[]

  @@index([activo])
  @@index([eliminado])
}

model Documento {
  id                  Int       @id @default(autoincrement())
  id_persona          Int
  tipo_documento      String
  nro_documento       String    @unique

  // Auditoría
  fecha_creacion      DateTime  @default(now())
  fecha_modificacion  DateTime?
  activo              Boolean   @default(true)
  eliminado           Boolean   @default(false)

  persona Persona @relation(fields: [id_persona], references: [id])

  @@index([id_persona])
  @@index([tipo_documento])
}

model Usuario {
  id                  Int       @id @default(autoincrement())
  id_persona          Int       @unique
  username            String    @unique
  password_hash       String

  // Auditoría
  fecha_creacion      DateTime  @default(now())
  fecha_modificacion  DateTime?
  activo              Boolean   @default(true)
  eliminado           Boolean   @default(false)

  persona       Persona      @relation("PersonaUsuario", fields: [id_persona], references: [id])
  roles         UsuarioRol[]
  asignaciones  Asignacion[]
  conexiones    Conexion[]

  @@index([id_persona])
  @@index([activo])
  @@index([eliminado])
}

model Contacto {
  id                  Int       @id @default(autoincrement())
  id_persona          Int
  tipo                String
  valor               String

  // Auditoría
  fecha_creacion      DateTime  @default(now())
  fecha_modificacion  DateTime?
  activo              Boolean   @default(true)
  eliminado           Boolean   @default(false)

  persona Persona @relation(fields: [id_persona], references: [id])

  @@index([id_persona])
  @@index([tipo])
}

//
// ────────────────────────────
//  GESTIÓN DE ROLES
// ────────────────────────────
//

model Rol {
  id                  Int       @id @default(autoincrement())
  nombre              String    @unique

  // Auditoría
  fecha_creacion      DateTime  @default(now())
  fecha_modificacion  DateTime?
  activo              Boolean   @default(true)
  eliminado           Boolean   @default(false)

  usuarios UsuarioRol[]

  @@index([activo])
  @@index([eliminado])
}

model UsuarioRol {
  id_usuario Int
  id_rol     Int

  usuario Usuario @relation(fields: [id_usuario], references: [id])
  rol     Rol     @relation(fields: [id_rol], references: [id])

  @@id([id_usuario, id_rol])
  @@index([id_usuario])
  @@index([id_rol])
}

//
// ────────────────────────────
//  VEHÍCULOS Y ASIGNACIONES
// ────────────────────────────
//

model Vehiculo {
  id                  Int       @id @default(autoincrement())
  placa               String    @unique
  modelo              String?
  anio                Int?

  // Auditoría
  fecha_creacion      DateTime  @default(now())
  fecha_modificacion  DateTime?
  activo              Boolean   @default(true)
  eliminado           Boolean   @default(false)

  asignaciones Asignacion[]
  conexiones   Conexion[]
  ubicaciones  Ubicacion[]

  @@index([activo])
  @@index([eliminado])
}

model Asignacion {
  id                  Int       @id @default(autoincrement())
  id_usuario          Int
  id_vehiculo         Int
  fecha_inicio        DateTime  @default(now())
  fecha_fin           DateTime?

  // Auditoría
  fecha_creacion      DateTime  @default(now())
  fecha_modificacion  DateTime?
  activo              Boolean   @default(true)
  eliminado           Boolean   @default(false)

  usuario  Usuario  @relation(fields: [id_usuario], references: [id])
  vehiculo Vehiculo @relation(fields: [id_vehiculo], references: [id])

  @@index([id_usuario])
  @@index([id_vehiculo])
  @@index([activo])
}

//
// ────────────────────────────
//  CONEXIONES Y UBICACIONES
// ────────────────────────────
//

model Conexion {
  id                  Int       @id @default(autoincrement())
  id_usuario          Int
  id_vehiculo         Int
  conectado_at        DateTime  @default(now())
  desconectado_at     DateTime?
  estado              Boolean   @default(true)
  ip                  String?
  sesion_dispositivo          String?

  // Auditoría
  fecha_creacion      DateTime  @default(now())
  fecha_modificacion  DateTime?
  activo              Boolean   @default(true)
  eliminado           Boolean   @default(false)

  usuario  Usuario  @relation(fields: [id_usuario], references: [id])
  vehiculo Vehiculo @relation(fields: [id_vehiculo], references: [id])

  @@index([id_usuario])
  @@index([id_vehiculo])
  @@index([estado])
}

model Ubicacion {
  id                  Int       @id @default(autoincrement())
  id_vehiculo         Int
  fecha_hora          DateTime  @default(now())
  latitud             Float
  longitud            Float
  velocidad_kmh       Float?

  // Auditoría
  fecha_creacion      DateTime  @default(now())
  fecha_modificacion  DateTime?
  activo              Boolean   @default(true)
  eliminado           Boolean   @default(false)

  vehiculo Vehiculo @relation(fields: [id_vehiculo], references: [id])

  @@index([id_vehiculo])
  @@index([fecha_hora])
}
